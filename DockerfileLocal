FROM agent0ai/agent-zero-base:latest

ARG BRANCH=local
ENV BRANCH=$BRANCH

COPY ./docker/run/fs/ /
COPY ./ /git/agent-zero

# Correção agressiva para o erro de 'numpy.ufunc'
# Removemos qualquer resquício e instalamos a versão estável ANTES de tudo
RUN /opt/venv-a0/bin/pip uninstall -y numpy scipy scikit-learn
RUN /opt/venv-a0/bin/pip install "numpy<2.0.0" "scipy<1.13.0" "scikit-learn"

RUN bash /ins/pre_install.sh $BRANCH
RUN bash /ins/install_A0.sh $BRANCH
RUN bash /ins/install_additional.sh $BRANCH

ARG CACHE_DATE=none
RUN echo "cache buster $CACHE_DATE" && bash /ins/install_A02.sh $BRANCH
RUN bash /ins/post_install.sh $BRANCH

EXPOSE 22 80 9000-9009
RUN chmod +x /exe/initialize.sh /exe/run_A0.sh /exe/run_searxng.sh /exe/run_tunnel_api.sh

# Railway usa essa variável para o healthcheck e roteamento
ENV PORT=80

CMD ["/exe/initialize.sh", "local"]
